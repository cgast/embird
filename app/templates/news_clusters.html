{% extends "base.html" %}

{% block title %}News Clusters{% endblock %}

{% block content %}
<!-- Server data -->
<script type="application/json" id="serverData">
{
    "error": {% if error %}{{ error | tojson | safe }}{% else %}null{% endif %},
    "clusters": {% if initial_clusters %}{{ initial_clusters | tojson | safe }}{% else %}null{% endif %}
}
</script>

<div class="row mb-4">
    <div class="col">
        <h1>Cluster</h1>
        <p class="lead">
            Display current/recent news clustered by vector similarity.
        </p>
    </div>
</div>

<div class="row">
    <div class="col">
        <div id="clustersContainer">
            <!-- Clusters will be loaded here -->
        </div>
    </div>
</div>

<template id="clusterTemplate">
    <div class="mb-4 cluster-container">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0 cluster-name"></h5>
            <div>
                <span class="badge bg-secondary subcluster-badge me-1" style="display: none;"><span class="subcluster-count"></span> subtopics</span>
                <span class="badge bg-primary"><span class="article-count"></span> articles</span>
            </div>
        </div>
        <details class="cluster-details">
            <summary class="center-article">
                <!-- Center article will be inserted here -->
            </summary>
            <div class="subclusters-container mt-3">
                <!-- Subclusters will be inserted here if present -->
            </div>
            <div class="list-group list-group-flush related-news mt-3">
                <!-- Related articles will be inserted here (flat mode) -->
            </div>
        </details>
    </div>
</template>

<template id="subclusterTemplate">
    <div class="subcluster mb-3">
        <details class="subcluster-details">
            <summary class="subcluster-header">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="subcluster-name fw-semibold"></span>
                    <span class="badge bg-info"><span class="subcluster-article-count"></span> articles</span>
                </div>
            </summary>
            <div class="list-group list-group-flush subcluster-articles mt-2">
                <!-- Subcluster articles will be inserted here -->
            </div>
        </details>
    </div>
</template>

<template id="centerArticleTemplate">
    <div class="d-flex justify-content-between align-items-start">
        <div class="flex-grow-1">
            <div style="font-size: 1.4em;" class="news-title"></div>
            <div style="font-size: 0.7em;"><span class="news-date"></span> - <span class="news-source"></span></div>
        </div>
    </div>
    <details class="article-details mt-2">
        <summary>Show Summary</summary>
        <p class="mb-1 news-summary mt-2"></p>
    </details>
</template>

<template id="newsItemTemplate">
    <div class="list-group-item">
        <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
                <div style="font-size: 1.2em;" class="news-title"></div>
                <div style="font-size: 0.7em;">
                    <span class="badge bg-info me-2 similarity-badge"></span>
                    <span class="news-date"></span> - <span class="news-source"></span>
                </div>
            </div>
        </div>
        <details class="article-details mt-2">
            <summary>Show Summary</summary>
            <p class="mb-1 news-summary mt-2"></p>
        </details>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const clustersContainer = document.getElementById('clustersContainer');
    const clusterTemplate = document.getElementById('clusterTemplate');
    const subclusterTemplate = document.getElementById('subclusterTemplate');
    const centerArticleTemplate = document.getElementById('centerArticleTemplate');
    const newsItemTemplate = document.getElementById('newsItemTemplate');

    // Parse server data
    const serverData = JSON.parse(document.getElementById('serverData').textContent);

    function createArticleElement(item, showSimilarity = true) {
        const newsElement = newsItemTemplate.content.cloneNode(true);

        newsElement.querySelector('.news-title').textContent = item.title;
        newsElement.querySelector('.news-summary').textContent = item.summary || 'No summary available';
        newsElement.querySelector('.news-source').textContent = new URL(item.source_url).hostname;
        newsElement.querySelector('.news-date').textContent = new Date(item.last_seen_at).toLocaleDateString();

        // Add similarity badge
        if (showSimilarity) {
            const similarityPercent = Math.round(item.similarity * 100);
            newsElement.querySelector('.similarity-badge').textContent = `${similarityPercent}%`;
        } else {
            newsElement.querySelector('.similarity-badge').style.display = 'none';
        }

        return newsElement;
    }

    function countSubclusters(subclusters) {
        if (!subclusters || subclusters.length <= 1) return 0;
        let count = subclusters.length;
        subclusters.forEach(sub => {
            if (sub.subclusters && sub.subclusters.length > 1) {
                count += countSubclusters(sub.subclusters);
            }
        });
        return count;
    }

    function renderSubclusterTree(subclusters, container, depth) {
        if (!subclusters) return;

        subclusters.forEach((subcluster, subIndex) => {
            const subDiv = document.createElement('div');
            subDiv.className = 'subcluster';
            subDiv.style.marginLeft = (depth * 0.5) + 'rem';
            if (depth > 0) {
                const colors = ['#0d6efd', '#7c3aed', '#2563eb', '#0891b2'];
                subDiv.style.borderLeftColor = colors[Math.min(depth, colors.length - 1)];
            }

            const hasChildren = subcluster.subclusters && subcluster.subclusters.length > 1;

            const details = document.createElement('details');
            details.className = 'subcluster-details';

            const summary = document.createElement('summary');
            summary.className = 'subcluster-header';
            summary.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <span class="subcluster-name fw-semibold">${subcluster.name || 'Subtopic ' + (subIndex + 1)}</span>
                    <span>
                        ${hasChildren ? '<span class="badge bg-secondary me-1">' + subcluster.subclusters.length + ' subtopics</span>' : ''}
                        <span class="badge bg-info">${subcluster.articles.length} articles</span>
                    </span>
                </div>
            `;
            details.appendChild(summary);

            if (hasChildren) {
                // Recursive: render child subclusters
                const childContainer = document.createElement('div');
                childContainer.className = 'mt-2';
                renderSubclusterTree(subcluster.subclusters, childContainer, depth + 1);
                details.appendChild(childContainer);
            } else {
                // Leaf: render articles
                const articlesContainer = document.createElement('div');
                articlesContainer.className = 'list-group list-group-flush subcluster-articles mt-2';
                subcluster.articles.forEach(item => {
                    articlesContainer.appendChild(createArticleElement(item));
                });
                details.appendChild(articlesContainer);
            }

            subDiv.appendChild(details);
            container.appendChild(subDiv);
        });
    }

    function displayClusters(clusters) {
        clustersContainer.innerHTML = '';

        if (!clusters || Object.keys(clusters).length === 0) {
            clustersContainer.innerHTML = `
                <div class="alert alert-info">
                    No news clusters found for the selected criteria.
                </div>
            `;
            return;
        }

        Object.entries(clusters).forEach(([clusterId, clusterData], index) => {
            const clusterElement = clusterTemplate.content.cloneNode(true);

            // Handle both old format (array) and new format (object with articles/subclusters)
            const isNewFormat = clusterData && typeof clusterData === 'object' && !Array.isArray(clusterData);
            const articles = isNewFormat ? clusterData.articles : clusterData;
            const subclusters = isNewFormat ? clusterData.subclusters : null;
            const clusterName = isNewFormat ? clusterData.name : null;

            // Set cluster name if available
            if (clusterName) {
                clusterElement.querySelector('.cluster-name').textContent = clusterName;
            }

            clusterElement.querySelector('.article-count').textContent = articles.length;

            // Get the center article (first item in the sorted list)
            const centerArticle = articles[0];
            const centerElement = centerArticleTemplate.content.cloneNode(true);

            // Populate center article
            centerElement.querySelector('.news-title').textContent = centerArticle.title;
            centerElement.querySelector('.news-summary').textContent = centerArticle.summary || 'No summary available';
            centerElement.querySelector('.news-source').textContent = new URL(centerArticle.source_url).hostname;
            centerElement.querySelector('.news-date').textContent = new Date(centerArticle.last_seen_at).toLocaleDateString();

            clusterElement.querySelector('.center-article').appendChild(centerElement);

            const subclusterContainer = clusterElement.querySelector('.subclusters-container');
            const relatedContainer = clusterElement.querySelector('.related-news');

            // Check if we have subclusters (recursive tree format)
            if (subclusters && subclusters.length > 1) {
                // Show subcluster badge with total count
                const subclusterBadge = clusterElement.querySelector('.subcluster-badge');
                subclusterBadge.style.display = 'inline-block';
                clusterElement.querySelector('.subcluster-count').textContent = countSubclusters(subclusters);

                // Hide flat related news container
                relatedContainer.style.display = 'none';

                // Render recursive subcluster tree
                renderSubclusterTree(subclusters, subclusterContainer, 0);
            } else {
                // Hide subclusters container in flat mode
                subclusterContainer.style.display = 'none';

                // Add related articles (skip the first/center article)
                articles.slice(1).forEach(item => {
                    relatedContainer.appendChild(createArticleElement(item));
                });
            }

            clustersContainer.appendChild(clusterElement);
        });
    }

    // Initialize with server data
    if (serverData.error) {
        clustersContainer.innerHTML = `
            <div class="alert alert-danger">
                ${serverData.error}
            </div>
        `;
    } else if (serverData.clusters) {
        displayClusters(serverData.clusters);
    }
});
</script>

<style>
.cluster-details {
    cursor: pointer;
}

.cluster-details summary {
    list-style: none;
    padding: 1rem;
    margin: -1rem;
    border-radius: 0.25rem;
    transition: background-color 0.2s;
}

.cluster-details summary:hover {
    background-color: rgba(0, 0, 0, 0.03);
}

.cluster-details summary::marker {
    display: none;
}

.cluster-details summary::-webkit-details-marker {
    display: none;
}

.cluster-details summary::after {
    content: '▼';
    float: right;
    transform: rotate(-90deg);
    transition: transform 0.2s;
}

.cluster-details[open] summary::after {
    transform: rotate(0);
}

/* Subcluster styles */
.subcluster {
    border-left: 3px solid #0d6efd;
    padding-left: 1rem;
    margin-left: 0.5rem;
}

.subcluster-details {
    cursor: pointer;
}

.subcluster-details summary {
    list-style: none;
    padding: 0.75rem;
    margin: -0.75rem;
    border-radius: 0.25rem;
    transition: background-color 0.2s;
    background-color: rgba(13, 110, 253, 0.05);
}

.subcluster-details summary:hover {
    background-color: rgba(13, 110, 253, 0.1);
}

.subcluster-details summary::marker {
    display: none;
}

.subcluster-details summary::-webkit-details-marker {
    display: none;
}

.subcluster-details summary::after {
    content: '▼';
    float: right;
    transform: rotate(-90deg);
    transition: transform 0.2s;
    font-size: 0.8em;
}

.subcluster-details[open] summary::after {
    transform: rotate(0);
}

.subcluster-name {
    color: #0d6efd;
}

.subcluster-articles {
    margin-left: 0.5rem;
}

.article-details {
    cursor: pointer;
}

.article-details summary {
    list-style: none;
    padding: 0.5rem;
    margin: -0.5rem;
    border-radius: 0.25rem;
    transition: background-color 0.2s;
    color: #0d6efd;
    font-size: 0.9em;
}

.article-details summary:hover {
    background-color: rgba(0, 0, 0, 0.03);
}

.article-details summary::marker {
    display: none;
}

.article-details summary::-webkit-details-marker {
    display: none;
}

.similarity-badge {
    font-size: 0.75rem;
}

.cluster-name {
    color: #495057;
}
</style>
{% endblock %}
